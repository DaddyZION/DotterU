<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stream Joystick Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Control a Viking!</h1>
  <div class="panel">
    <input id="username" placeholder="Enter username" maxlength="16" autocomplete="off" />
    <input type="color" id="color" title="Pick your color" />
    <button id="enterBtn">Enter</button>
    <button id="danceBtn" disabled>üï∫ Dance Mode</button>
    <button id="flyBtn" disabled>‚úàÔ∏è Fly Around</button>
  </div>
  <div id="joystick"></div>
  <div class="footer">
    Powered by DotterU &middot; Use the joystick to move your character!
  </div>
  <script>
let socket, username, color, joystick, joined = false;

// Generate a random bright HEX color
function getRandomBrightHexColor() {
  const h = Math.floor(Math.random() * 360);
  const s = 90, l = 60;
  let rgb = hslToRgb(h, s, l);
  return rgbToHex(rgb[0], rgb[1], rgb[2]);
}

// HSL to RGB helper
function hslToRgb(h, s, l) {
  s /= 100; l /= 100;
  let c = (1 - Math.abs(2 * l - 1)) * s,
      x = c * (1 - Math.abs((h / 60) % 2 - 1)),
      m = l - c/2, r=0, g=0, b=0;
  if (0 <= h && h < 60) { r = c; g = x; b = 0; }
  else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
  else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
  else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
  else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
  else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
  r = Math.round((r + m) * 255);
  g = Math.round((g + m) * 255);
  b = Math.round((b + m) * 255);
  return [r, g, b];
}

// RGB to HEX helper
function rgbToHex(r, g, b) {
  return "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
}

// Set initial color
const colorInput = document.getElementById('color');
colorInput.value = getRandomBrightHexColor();
colorInput.style.background = colorInput.value;
let pickedColor = colorInput.value;

colorInput.addEventListener('input', function() {
  pickedColor = colorInput.value;
  colorInput.style.background = pickedColor;
});

// Always show and initialize the joystick
function setupJoystick() {
  const joystickDiv = document.getElementById('joystick');
  // Remove previous joystick if any
  if (joystick && joystick.destroy) joystick.destroy();
  joystick = nipplejs.create({
    zone: joystickDiv,
    mode: 'static',
    position: { left: '50%', top: '50%' },
    color: '#ff2222', // bright red for visibility
    size: Math.min(joystickDiv.offsetWidth, joystickDiv.offsetHeight) - 20
  });

  let lastMoveSent = 0;
  joystick.on('move', function (evt, data) {
    const now = Date.now();
    if (
      joined &&
      data &&
      data.angle && // <--- use angle, not direction
      socket &&
      socket.readyState === 1 &&
      now - lastMoveSent > 50 // throttle
    ) {
      lastMoveSent = now;
      socket.send(JSON.stringify({
        type: 'move',
        username,
        direction: data.angle.degree, // <--- always send angle in degrees
        force: data.force
      }));
    }
  });
}
setupJoystick();

// Dancing mode variables
let isDancing = false;
let isFlying = false;
let danceInterval = null;
let flyInterval = null;
let beatCount = 0;
let facingRight = true;
let bouncePhase = 0;

// Flying variables
let flyX = 400, flyY = 300;
let flyDX = 6, flyDY = 4;

// Dance button functionality (faster, smaller jiggle bounce)
const danceBtn = document.getElementById('danceBtn');
danceBtn.onclick = function() {
  if (!joined) return;
  
  isDancing = !isDancing;
  
  if (isDancing) {
    // Stop flying if active
    if (isFlying) {
      isFlying = false;
      clearInterval(flyInterval);
      flyInterval = null;
      document.getElementById('flyBtn').textContent = '‚úàÔ∏è Fly Around';
      document.getElementById('flyBtn').style.background = '#5a6cff';
    }
    
    // Start dancing
    danceBtn.textContent = 'üõë Stop Dancing';
    danceBtn.style.background = '#ff4444';
    
    // Stop WASD movement if active
    if (wasdInterval) {
      clearInterval(wasdInterval);
      wasdInterval = null;
    }
    
    beatCount = 0;
    facingRight = true;
    bouncePhase = 0;
    
    // Start jiggle bounce (1 bounce per second, small movement)
    danceInterval = setInterval(() => {
      // Small jiggle bounce up and down
      bouncePhase += 0.1; // Increment for 1 bounce per second (10 updates * 0.1 = 1 full cycle)
      let bounceAngle = Math.sin(bouncePhase * Math.PI * 2) * 15; // ¬±15 degrees (small jiggle)
      
      // Primarily vertical movement (up = 270¬∞, down = 90¬∞)
      let direction = 270 + bounceAngle; // Up direction with small bounce
      
      // Add slight horizontal component based on facing direction
      if (!facingRight) direction = 270 - bounceAngle;
      
      socket.send(JSON.stringify({
        type: 'move',
        username,
        direction: direction,
        force: 0.2 // Very light force for jiggle effect
      }));
      
      beatCount++;
      if (beatCount >= 10) { // After 1 second (10 * 100ms), flip direction
        facingRight = !facingRight;
        beatCount = 0;
      }
      
    }, 100); // 100ms = 10 updates per second
    
  } else {
    // Stop dancing
    danceBtn.textContent = 'üï∫ Dance Mode';
    danceBtn.style.background = '#5a6cff';
    
    if (danceInterval) {
      clearInterval(danceInterval);
      danceInterval = null;
    }
  }
};

// Fly Around button functionality (more random)
const flyBtn = document.getElementById('flyBtn');
flyBtn.onclick = function() {
  if (!joined) return;
  
  isFlying = !isFlying;
  
  if (isFlying) {
    // Stop dancing if active
    if (isDancing) {
      isDancing = false;
      clearInterval(danceInterval);
      danceInterval = null;
      danceBtn.textContent = 'üï∫ Dance Mode';
      danceBtn.style.background = '#5a6cff';
    }
    
    // Start flying
    flyBtn.textContent = 'üõë Stop Flying';
    flyBtn.style.background = '#ff4444';
    
    // Stop WASD movement if active
    if (wasdInterval) {
      clearInterval(wasdInterval);
      wasdInterval = null;
    }
    
    // Reset flying position with random starting point
    flyX = Math.random() * 1000 + 200;
    flyY = Math.random() * 600 + 200;
    flyDX = (Math.random() - 0.5) * 16 + 6; // Random speed between -2 and 14
    flyDY = (Math.random() - 0.5) * 16 + 4; // Random speed between -4 and 12
    
    // Start flying animation
    flyInterval = setInterval(() => {
      // Update position
      flyX += flyDX;
      flyY += flyDY;
      
      // Bounce off walls with random direction changes
      if (flyX <= 50 || flyX >= 1870) {
        flyDX = -flyDX + (Math.random() - 0.5) * 4; // Add randomness to bounce
        flyDX = Math.max(-12, Math.min(12, flyDX)); // Keep speed reasonable
      }
      if (flyY <= 50 || flyY >= 1030) {
        flyDY = -flyDY + (Math.random() - 0.5) * 4; // Add randomness to bounce
        flyDY = Math.max(-12, Math.min(12, flyDY)); // Keep speed reasonable
      }
      
      // Occasionally change direction randomly (10% chance each update)
      if (Math.random() < 0.1) {
        flyDX += (Math.random() - 0.5) * 6;
        flyDY += (Math.random() - 0.5) * 6;
        flyDX = Math.max(-12, Math.min(12, flyDX));
        flyDY = Math.max(-12, Math.min(12, flyDY));
      }
      
      // Calculate movement direction
      let direction = Math.atan2(-flyDY, flyDX) * 180 / Math.PI;
      
      socket.send(JSON.stringify({
        type: 'move',
        username,
        direction: direction,
        force: 1.2 // Moderate force for flying movement
      }));
      
    }, 60); // 60ms = ~16 updates per second (smooth flying)
    
  } else {
    // Stop flying
    flyBtn.textContent = '‚úàÔ∏è Fly Around';
    flyBtn.style.background = '#5a6cff';
    
    if (flyInterval) {
      clearInterval(flyInterval);
      flyInterval = null;
    }
  }
};

// Update the enterBtn onclick to enable both buttons
document.getElementById('enterBtn').onclick = function(e) {
  e.preventDefault();
  username = document.getElementById('username').value.trim();
  if (!username) return alert('Please enter a username!');
  color = pickedColor;
  socket = new WebSocket('wss://dotteru.onrender.com');
  socket.onopen = function() {
    socket.send(JSON.stringify({ type: 'join', username, color }));
    joined = true;
    danceBtn.disabled = false; // Enable dance button
    flyBtn.disabled = false;   // Enable fly button
  };
  document.getElementById('username').disabled = true;
  document.getElementById('color').disabled = true;
  document.getElementById('enterBtn').disabled = true;

  socket.onmessage = function(event) {
    const msg = JSON.parse(event.data);
    if (msg.type === 'error') {
      alert(msg.message);
      document.getElementById('username').disabled = false;
      document.getElementById('color').disabled = false;
      document.getElementById('enterBtn').disabled = false;
      joined = false;
      socket.close();
      danceBtn.disabled = true; // Disable dance button on error
      flyBtn.disabled = true;   // Disable fly button on error
    }
  };
};

// Mobile: allow pressing Enter on keyboard to submit
document.getElementById('username').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('enterBtn').click();
  }
});

// Track which keys are pressed
const keysDown = {};
let wasdInterval = null;

document.addEventListener('keydown', function(e) {
  if (!socket || socket.readyState !== WebSocket.OPEN) return;
  if (!joined || isDancing || isFlying) return; // Don't allow WASD when dancing or flying

  keysDown[e.key.toLowerCase()] = true;

  if (!wasdInterval) {
    wasdInterval = setInterval(sendWASDMove, 30); // 30ms for smooth movement
  }
});

document.addEventListener('keyup', function(e) {
  keysDown[e.key.toLowerCase()] = false;

  // Stop interval if no WASD keys are pressed
  if (!keysDown['w'] && !keysDown['a'] && !keysDown['s'] && !keysDown['d']) {
    clearInterval(wasdInterval);
    wasdInterval = null;
  }
});

function sendWASDMove() {
  let dx = 0, dy = 0;
  if (keysDown['w']) dy -= 1;
  if (keysDown['s']) dy += 1;
  if (keysDown['a']) dx -= 1;
  if (keysDown['d']) dx += 1;

  if (dx !== 0 || dy !== 0) {
    // Calculate angle in degrees (0 = right, 90 = down, 180 = left, 270 = up)
    const angle = Math.atan2(-dy, dx) * 180 / Math.PI;
    socket.send(JSON.stringify({
      type: 'move',
      username,
      direction: angle,
      force: 1
    }));
  }
}
  </script>
</body>
</html>